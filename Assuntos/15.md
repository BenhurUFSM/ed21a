## Árvore AVL

Uma árvore binária de busca pode ter um desempenho muito bom para ser usada como uma estrutura de dados de busca, mas esse desempenho depende bastante da forma como os dados estão distribuídos na árvore.
Em casos extremos de distribuição masl feita, a árvore pode ficar com um nõ por nĩvel, resultando em um desempenho pior que uma lista linear.
Para que a estrutura da árvore seja bem aproveitada e se tenha um bom desempenho, é necessário que os dados estejam bem distribuĩdos na árvore, de forma equilibrada.
Uma forma de se ter uma árvore equilibrada é inserindo os dados nela em uma ordem otimizada, mas só é viável quando os dados são conhecidos de antemão.
Outra forma é reorganizar a árvore quando se detecta que ela está desequilibrada. 
Para isso, deve-se definir uma forma de se medir o equilĩbrio da árvore, e uma forma de se manter a árvore equilibrada (ou de reequilibrá-la quando um desequilibrio for detectado) quando houver alterações, causadas por inclusões e remoções de dados da árvore.

Existem vários tipos de árvores que [se auto-equilibram](https://en.wikipedia.org/wiki/Self-balancing_binary_search_tree). Vamos estudar um pouco mais a fundo uma delas, as **árvores AVL** (AVL são as iniciais dos inventores, Andelson-Velsky e Landis).

Em árvores AVL, o equilíbrio da árvore é dado pela diferença de altura entre as subárvores de um nó. A árvore é considerada equilibrada se todos os seus nós apresentam uma diferença entre a altura de seu filho esquerdo e de seu filho direito inferior a 2.
Essa diferença é chamada de *fator de equilíbrio*, e geralmente é calculada como a altura do filho esquerdo menos a do direito, e são aceitos valores 0, 1 ou -1.

A forma de se reequilibrar uma árvore AVL é durante as operações de inserção e remoção. Essas operações são realizadas como vimos para ABB, mas no final da operação, antes do retorno recursivo ao nó anterior, verifica-se o fator de equilíbrio do nó e se realiza uma operação de reequilíbrio caso seja necessário. Dessa forma, ao concluir a operação de inserção ou remoção, garante-se que a árvore encontra-se novamente equilibrada.

O reequilíbrio é realizado por meio de alterações chamadas *rotação*. Uma rotação envolve dois nós (pai e filho) e suas sub-árvores. Uma rotação não altera as características de ordenamento dos dados de uma ABB. Na figura abaixo, X e Y são nós da árvore, A, B e C são subárvores. Uma rotação à direita leva da árvore com raiz X para a árvore com raiz Y. Uma rotação à esquerda leva da árvore com raiz Y à árvore com raiz X. Em ambas as árvores da figura, a ordem dos valores está de acordo com as regras de uma ABB (todos os nõs de A têm valores menores que Y, os nós de B têm valores entre X e Y e os nós de C tẽm valores maiores que X).

![rotacao AVL]()

Vamos analisar primeiro o reequilíbrio de uma árvore AVL após uma inclusão; depois analisaremos a remoção. Antes da inclusão a árvore está equilibrada. A inclusão desequilibra a árvore. A ideia básica é que realizando a inclusão e retornando-se no caminho desde onde a inclusão foi realizada até a raiz, quando se encontra um nó que ficou desequilibrado, esse nó é rotacionado para corrigir esse desequilíbrio, e não é necessária a correção em nenhum outro ponto da árvore. Supondo que isso seja verdade, vamos considerar a árvore da esquerda da figura acima, onde uma inserção à esquerda de X causa um desequilíbrio em X. Pela nossa suposição, essa inserção não deve causar desequilíbrio em nenhum nó abaixo de X. Uma inserção que desequilibrasse o nó X para o outro lado (um valor maior que X) poderia ser tratada de forma semelhante (como se a árvore fosse espelhada).

Como a inserção será à esquerda de X, o nó X deve se desequilibrar porque há um aumento na altura de seu filho esquerdo (Y). Logo, antes da inserção, como a árvore está equilibrada, o fator de equilíbrio de X deve ser 1, e após a inserção deve virar 2.
Para que X tenha fator 1, a altura da árvore Y deve ser 1 a mais que a altura da árvore C. 
A inclusão será realizada na subárvore A ou B, e para que mude o fator de equilíbrio de X, essa subárvore deve aumentar sua altura, e deve se tornar a mais alta subárvore de Y. Caso A e B tenham altura diferente entre si, se a inclusão for na árvore menos alta, ela chegará no máximo até a altura da árvore mais alta, não alterando a altura de Y; se a inclusão for na árvore mais alta, ela aumentará ainda mais a diferença de altura para a árvore mais baixa, desequilibrando Y, o que vai contra nossa premissa de que o primeiro nó a ficar desequilibrado é X. Logo, A e B devem ter a mesma altura.
Supondo que a altura da árvore C seja *h*, a árvore antes da inclusão deve estar como a figura abaixo (a direita do nó foi colocada a altura, o fator de equilíbrio foi colocado acima de cada nó.

![AVL antes da inclusão]()

No primeiro caso, a inclusão será realizada na subárvore A, aumentando sua altura. Essa inclusão faz com que a árvore fique como a figura abaixo, com as alterações marcadas em vermelho.

![AVL depois da inclusão]()
